from selenium import webdriver
from pynput import keyboard
import time
import os
import base64

# ---------- SETUP ----------
SAVE_DIR = "SkillRack_FullPage_Screenshots"
os.makedirs(SAVE_DIR, exist_ok=True)

options = webdriver.EdgeOptions()
options.add_argument("--start-maximized")

driver = webdriver.Edge(options=options)

print("‚úÖ Edge opened by Selenium")
print("üëâ Open SkillRack in this Edge window")
print("üëâ Login and select unit manually")
print("üëâ Press 'S' to capture TRUE FULL PAGE")
print("üëâ Press 'ESC' to exit")

take_screenshot = False
exit_program = False
count = 1

# ---------- KEY LISTENER ----------
def on_press(key):
    global take_screenshot, exit_program
    try:
        if key.char.lower() == 's':
            take_screenshot = True
    except AttributeError:
        if key == keyboard.Key.esc:
            exit_program = True
            return False

listener = keyboard.Listener(on_press=on_press)
listener.start()

# ---------- MAIN LOOP ----------
try:
    while not exit_program:
        if take_screenshot:
            take_screenshot = False

            try:
                # Ensure browser window exists
                if not driver.window_handles:
                    print("‚ùå Browser window closed")
                    break

                driver.switch_to.window(driver.window_handles[0])

                # --- TRUE FULL PAGE SCREENSHOT via DevTools ---
                result = driver.execute_cdp_cmd(
                    "Page.captureScreenshot",
                    {
                        "format": "png",
                        "captureBeyondViewport": True,
                        "fromSurface": True
                    }
                )

                image_data = base64.b64decode(result["data"])
                file_path = f"{SAVE_DIR}/unit_{count}.png"

                with open(file_path, "wb") as f:
                    f.write(image_data)

                print(f"üì∏ Saved FULL PAGE: {file_path}")
                count += 1

            except Exception as e:
                print("‚ö†Ô∏è Screenshot failed:", e)

        time.sleep(0.1)

finally:
    print("üëã Exiting")
    driver.quit()
